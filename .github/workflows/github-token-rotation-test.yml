name: 'GitHub Token Rotation'

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch: {}

jobs:
  rotate-github-token:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Validate Environment Variables
        env:  
          VILNACRM_APP_ID: ${{ secrets.VILNACRM_APP_ID }}
          VILNACRM_APP_PRIVATE_KEY: ${{ secrets.VILNACRM_APP_PRIVATE_KEY }}
        run: |
          if [ -z "${{ secrets.VILNACRM_APP_ID }}" ] || [ -z "${{ secrets.VILNACRM_APP_PRIVATE_KEY }}" ]; then
            if [ -z "${{ secrets.VILNACRM_APP_ID }}" ]; then
              echo "Error: VILNACRM_APP_ID is not set in secrets."
            fi
            if [ -z "${{ secrets.VILNACRM_APP_PRIVATE_KEY }}" ]; then
              echo "Error: VILNACRM_APP_PRIVATE_KEY is not set in secrets."
            fi
          fi
          
          # Validate App ID format (should be numeric)
          if ! [[ "${{ secrets.VILNACRM_APP_ID }}" =~ ^[0-9]+$ ]]; then
            echo "Error: VILNACRM_APP_ID should be a numeric value."
            exit 1
          fi
          # Validate private key format (should start with -----BEGIN)
          if ! echo "${{ secrets.VILNACRM_APP_PRIVATE_KEY }}" | grep -q "^-----BEGIN"; then
            echo "Error: VILNACRM_APP_PRIVATE_KEY should be in PEM format."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2.2.0
        with:
          # Assume IAM role for GitHub Actions to access AWS resources
          role-to-assume: ${{ secrets.GITHUB_TOKEN_ROTATION_ROLE_TO_ASSUME_TEST }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          if ! aws sts get-caller-identity &>/dev/null; then
            echo "Error: Failed to configure AWS credentials"
            exit 1
          fi

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-    

      - name: Install PyJWT
        run: |
          pip3 install "PyJWT==2.8.0"
          installed_version=$(python3 -c "import jwt; print(jwt.__version__)" 2>/dev/null)
          expected_version="2.8.0"
          if [ -z "$installed_version" ]; then
            echo "Error: Failed to install PyJWT"
            exit 1
          elif [ "$installed_version" != "$expected_version" ]; then
            echo "Error: Incorrect PyJWT version. Expected $expected_version, got $installed_version"
            exit 1
          fi

      - name: Rotate GitHub Token
        env:
          SECRET_NAME: ${{ secrets.SECRET_NAME }}
        run: |
          set -euo pipefail

          echo "Generating new GitHub token..."

          # Authenticate as a GitHub App
          jwt=$(python3 -c "import jwt, time, os; print(jwt.encode({'iat': int(time.time()), 'exp': int(time.time()) + 600, 'iss': os.environ['GITHUB_APP_ID']}, os.environ['GITHUB_PRIVATE_KEY'].replace('\\n', '\n'), algorithm='RS256'))")

          # Get installation ID
          response=$(curl -s \
            -H "Authorization: Bearer $jwt" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/app/installations)

          installation_id=$(echo "$response" | jq -r '.[0].id')

          if [ -z "$installation_id" ] || [ "$installation_id" = "null" ]; then
            echo "Failed to retrieve installation ID"
            exit 1
          fi

          # Create an installation access token
          token_response=$(curl -s -X POST \
            -H "Authorization: Bearer $jwt" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/app/installations/$installation_id/access_tokens)

          NEW_TOKEN=$(echo "$token_response" | jq -r '.token')

          if [ -z "$NEW_TOKEN" ] || [ "$NEW_TOKEN" = "null" ]; then
            echo "Failed to generate new token"
            exit 1
          fi

          # Store the new token in AWS Secrets Manager
          aws secretsmanager put-secret-value --secret-id "${SECRET_NAME}" --secret-string "${NEW_TOKEN}" --version-stage "AWSCURRENT"

          echo "GitHub token has been rotated and updated in AWS Secrets Manager."
