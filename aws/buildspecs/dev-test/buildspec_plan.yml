version: 0.2

env:
  variables:
    CODE_SRC_DIR: '.'
    TF_VERSION: '1.6.6'
    PYTHON_VERSION: '3.12'
    RUBY_VERSION: '3.2'

phases:
  install:
    runtime-versions:
      python: $PYTHON_VERSION
      ruby: $RUBY_VERSION
    commands:
      - 'touch ~/config'
      - 'touch ~/credentials'
      - 'echo "[profile terraform]" > ~/config'
      - 'echo "region = ${AWS_DEFAULT_REGION}" >> ~/config'
      - 'echo "[terraform]" > ~/credentials'
      - 'echo "aws_access_key_id = $(aws secretsmanager get-secret-value --secret-id test/AWS/Website --query SecretString --output text | jq -r ".WEBSITE_AWS_ACCESS_KEY")" >> ~/credentials'
      - 'echo "aws_secret_access_key = $(aws secretsmanager get-secret-value --secret-id test/AWS/Website --query SecretString --output text | jq -r ".WEBSITE_AWS_SECRET_KEY")" >> ~/credentials'
      - 'mkdir ~/.aws/'
      - 'mv ~/config ~/.aws/config'
      - 'mv ~/credentials ~/.aws/credentials'
      - 'rm ~/config'
      - 'rm ~/credentials'
      - 'export AWS_PROFILE=terraform'
      - 'yum install -y yum-utils'
      - 'yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo'
      - 'yum -y install terraform'
      - 'bundle install --gemfile ${CODEBUILD_SRC_DIR}/terraform/Gemfile'
  build:
    commands:
      - 'cd ${CODEBUILD_SRC_DIR}/terraform'
      - 'echo ## TERRASPACE PLAN : Generate the Terraform Plan'
      - 'terraspace all plan --out "tf.plan"'

artifacts:
  files:
    - '**/*'
